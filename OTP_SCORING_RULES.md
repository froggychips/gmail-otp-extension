# OTP Scoring Rules (Current)

Этот документ описывает актуальные правила выбора OTP в `src/background/otp-detector.js`.

## 1) Поиск кандидатов

Из текста (subject + snippet + body) извлекаются кандидаты:
- Числовые коды: `4-8` цифр.
- Буквенно-цифровые коды: `4-10` символов (минимум 1 буква и 1 цифра).
- Коды с дефисом: форматы вида `123-456`.
- Коды после маркеров (`otp`, `code`, `pin`, `verification`, `код`, и т.д.): например `Code: ftkdw`.

Дополнительно фильтруются заведомо шумовые токены (`code`, `login`, `otp`, и т.д.) и пользовательские stop words.

## 2) Базовый score формата

- Domain preference (обучение): `+100` (если формат кода совпадает с сохраненным предпочтением домена).
- Чисто числовой:
  - 6 цифр: `60`
  - 4 цифры: `45`
  - 5/7/8 цифр: `40`
  - для 4-значных годов (`19xx`, `20xx`) применяется штраф `-10`.
- Буквенно-цифровой: `55` (и `+5`, если весь в uppercase).
- С дефисом и цифрами: `58`.
- Чисто словесной кандидат:
  - `0` для uppercase-слов,
  - `-20` для Capitalized слов,
  - `-10` для остальных.
- Жесткий blacklist stop words: `-100`.

## 3) Контекстный score

Для каждого кандидата применяется контекстный скоринг:
- Бонусы за близость к OTP-лексике (`otp`, `code`, `verification`, `код`, и т.д.) в subject/snippet/body.
- Штрафы за transactional-контекст (`order`, `booking`, `reservation`, `invoice`, и т.д.).
- Дополнительный бонус, если кандидат явно идет после маркера `code:`/`otp:`.
- Дополнительный доменный штраф для travel/booking-доменов.

## 4) Финальный выбор

Итоговый score = `baseScore + contextScore`.
Сортировка:
1. по `score` (убывание),
2. по `contextScore` (убывание),
3. по `baseScore` (убывание).

Возвращается лучший кандидат + список альтернатив (`others`).
