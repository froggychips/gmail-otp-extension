<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gmail OTP</title>
    <link rel="stylesheet" href="popup.css" />
  </head>
  <body>
    <main class="app">
      <!-- Header -->
      <header class="header">
        <div class="logo-group">
          <svg class="logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail-search"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/><path d="M18 12v1"/><path d="M18 16v1"/><path d="M18 20v1"/></svg>
          <div class="title">Gmail OTP</div>
          <button id="accountToggle" class="account-toggle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span id="accountIndicator" class="indicator"></span>
          </button>
        </div>
        <div id="status" class="status-badge" data-t="idle">Готово</div>
        <span id="lastCheckTime" style="margin-left:12px; font-size:11px; color:var(--text-secondary);"></span>
      </header>

      <!-- Account Dropdown (Hidden by default) -->
      <div id="accountDropdown" class="account-dropdown">
        <div class="card" style="margin-bottom:0; border:none; box-shadow:none;">
          <div class="card-title" data-t="account">Аккаунты</div>
          
          <div id="accountList" style="margin-bottom: 12px;">
            <!-- Dynamic list of accounts -->
          </div>

          <div class="field-group" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px; margin-bottom:0;">
            <button id="gmailConnect" class="btn btn-primary" data-t="connect">Добавить аккаунт</button>
          </div>
          
          <div class="hint" data-t="profileNote" style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 8px; font-size: 10px;">
            Используется аккаунт профиля Chrome
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="tabs-nav">
        <button class="tab-btn active" data-tab="code">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <span data-t="code">Код</span>
        </button>
        <button class="tab-btn" data-tab="history">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
          <span data-t="history">История</span>
        </button>
        <button class="tab-btn" data-tab="filters">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
          <span data-t="filters">Фильтры</span>
        </button>
        <button class="tab-btn" data-tab="tools">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span data-t="tools">Инструменты</span>
        </button>
      </nav>

      <!-- Content: Code -->
      <div class="tabs-content active" id="tab-code">
        <div class="otp-hero" id="gmailCodeWrapper" style="cursor:pointer">
          <div class="otp-meta" data-t="lastFound">Последний найденный код</div>
          <div id="gmailCode" class="otp-code">—</div>
          <div id="gmailMeta" class="otp-meta">—</div>
        </div>

        <div class="card">
          <div class="card-title" data-t="mode">Режим работы</div>
          <div class="toggle-group" style="display: flex; background: var(--bg-secondary); padding: 4px; border-radius: 8px; border: 1px solid var(--border);">
            <button id="modeAuto" class="tab-btn active" style="flex:1; padding: 6px;" data-t="auto">Авто</button>
            <button id="modeManual" class="tab-btn" style="flex:1; padding: 6px;" data-t="manual">Ручной</button>
          </div>
          <div class="hint" id="modeHint" style="font-size: 11px; margin-top: 8px; color: var(--text-secondary);" data-t="autoDesc">Авто: проверка раз в минуту.</div>
        </div>
        
        <div class="field-group">
          <button id="gmailFetchCode" class="btn btn-primary">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <span data-t="manualSearch">Найти код вручную</span>
          </button>
        </div>
      </div>

      <!-- Content: History -->
      <div class="tabs-content" id="tab-history">
        <div class="card">
          <div class="card-title" data-t="historyTitle">Последние 10 кодов</div>
          <div id="historyList" class="history-list">
            <div class="list-item" data-t="empty">Список пуст</div>
          </div>
        </div>
      </div>

      <!-- Content: Filters -->
      <div class="tabs-content" id="tab-filters">
        <div class="card">
          <div class="card-title" data-t="searchSettings">Настройки поиска</div>
          
          <div class="switch-row">
            <label class="field-label" for="gmailUnreadOnly" style="margin-bottom:0" data-t="unreadOnly">Искать только в непрочитанных</label>
            <input id="gmailUnreadOnly" type="checkbox" />
          </div>
          <div class="hint" style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" data-t="unreadDesc">
            Рекомендуется: так расширение работает быстрее и точнее.
          </div>

          <div style="margin-top: 16px;">
            <button id="toggleAdvanced" class="btn btn-ghost" style="font-size: 11px; padding: 4px; border: none; background: transparent; color: var(--accent); justify-content: flex-start;">
              <span data-t="advanced">▶ Продвинутые настройки</span>
            </button>
            <div id="advancedSection" style="display: none; margin-top: 12px; border-top: 1px dashed var(--border); padding-top: 12px;">
              <div class="field-group">
                <label class="field-label" for="gmailQuery" data-t="rawQuery">Запрос Gmail (Query)</label>
                <input id="gmailQuery" type="text" style="font-family: monospace; font-size: 11px;" />
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title"><span data-t="recognition">Алгоритм распознавания</span></div>
          <div class="switch-row" style="margin-bottom: 8px;">
            <label class="field-label" style="margin:0"><span data-t="sensitivity">Чувствительность</span>: <span id="thresholdVal" style="color: var(--accent); font-weight: 700;">3</span></label>
          </div>
          <input id="gmailThreshold" type="range" min="1" max="8" value="3" step="1" />
          <div class="hint" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;" data-t="sensDesc">
            Низкая — ловит всё подряд.<br>Высокая — только 100% коды.
          </div>
        </div>
      </div>

      <!-- Content: Tools -->
      <div class="tabs-content" id="tab-tools">
        <div class="card">
          <div class="card-title" data-t="logs">Логи системы</div>
          <div class="logs-container" id="logsList">—</div>
          <div class="field-group" style="display: flex; gap: 8px; margin-top: 8px;">
            <button id="refreshLogs" class="btn btn-ghost" style="flex:1" data-t="refresh">Обновить</button>
            <button id="clearLogs" class="btn btn-ghost" style="flex:1" data-t="clear">Очистить</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title" data-t="unmatched">Неопознанные письма</div>
          <div id="unmatchedList" style="max-height: 150px; overflow-y: auto;">—</div>
          <div class="field-group" style="display: flex; gap: 8px; margin-top: 8px;">
            <button id="undoAction" class="btn btn-ghost" disabled data-t="undo">Отменить</button>
            <button id="unmatchedClear" class="btn btn-ghost" data-t="clear">Очистить</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title" data-t="data">Данные</div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div style="display: flex; gap: 8px;">
              <button id="exportData" class="btn btn-ghost" style="flex:1" data-t="export">Экспорт</button>
              <button id="importData" class="btn btn-ghost" style="flex:1" data-t="import">Импорт</button>
            </div>
            <button id="resetExtension" class="btn btn-danger" style="width: 100%;" data-t="reset">Сбросить всё</button>
          </div>
        </div>
      </div>
    </main>
    <script src="popup.js"></script>
  </body>
</html>
